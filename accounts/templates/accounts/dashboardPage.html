{% extends 'base_main/baseDashboard.html' %}
{% load static %}
{% load gravatar_tags %}


{% block content %}
<style>
    .airport_arr {
        text-align: center;
        font-size: 30px;
        padding: 0 15px;
        line-height: 16px;
        max-height: 30px;
        text-overflow: ellipsis;
        color: #222;
    }

    .airport_dep {
        text-align: center;
        font-size: 30px;
        padding: 0 15px;
        line-height: 16px;
        max-height: 30px;
        text-overflow: ellipsis;
        color: #222;
    }

    .stats-figure {
        color: #222;
        opacity: .75;
        margin: 0;
        padding: 0;
        text-shadow: none;
        display: block;
        margin-bottom: 3px;
        white-space: nowrap;
        overflow: visible;
        letter-spacing: normal;
        cursor: default;
        line-height: normal;
        display: inline-block;
        width: 100%;
    }

    .stats-meta {
        font-size: 25px;
        display: flex;
        flex-direction: column;
        /* Adiciona dire√ß√£o de coluna */
        align-items: center;
    }

    .airport-container {
        display: flex;
        align-items: center;
    }

    .airport {
        margin-right: 10px;
        font-size: 20px;
    }

    .airplane-icon {
        width: 50px;
        margin: 0 10px;
    }

    .bottom-center {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        color: #222;
        /* Adiciona margem superior para espa√ßamento */

    }
</style>
<div class="app-content pt-3 p-md-3 p-lg-4">
    <div class="container-xl">
        <div class="app-card alert alert-dismissible shadow-sm mb-4 border-left-decoration" role="alert">
            <div class="inner">
                <div class="app-card-body p-3 p-lg-4">
                    <h3 class="mb-3">Bem vindo, {{ user.first_name }} {{ user.last_name }} üë®‚Äç‚úàÔ∏è</h3>
                    <div class="row gx-5 gy-3">
                        <div class="col-12 col-lg-9">

                            <div><h3><small class="text-body-secondary">{{metar}}</small></h3></div>
                        </div><!--//col-->
                        <div class="col-12 col-lg-3">
                            
                        </div><!--//col-->
                    </div><!--//row-->
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div><!--//app-card-body-->

            </div><!--//inner-->
        </div><!--//app-card-->

        <div class="row g-4 mb-4">
            <div class="col-6 col-lg-3">
                <div class="app-card app-card-stat shadow-sm h-100">
                    <div class="app-card-body p-3 p-lg-4 d-flex flex-column align-items-center">
                        <h4 class="stats-type mb-1">Plano de voo mais recente</h4>

                        <div class="stats-figure">{{ pireps_flights.first.flight_icao }}{{ pireps_flights.first.flight_number }}</div>
                        <br>
                        <div class="stats-meta text-success">
                            <div class="airport-container">
                                <div>
                                    <span class="airport_dep"
                                        id="departures">{{pireps_flights.first.departure_airport}}</span>
                                    <hr class="border border-secondary-subtle border-2 opacity-50">
                                    <p id="departure-result" class="airport_dep lead"></p>
                                </div>

                                <img class="airplane-icon" src="{% static 'image/icon-airplane.png' %}"
                                    alt="Airplane Icon">

                                <div>
                                    <span class="airport_arr"
                                        id="arrivals">{{pireps_flights.first.arrival_airport}}</span>
                                    <hr class="border border-secondary-subtle border-2 opacity-50">
                                    <p id="arrival-result" class="airport_dep lead"></p>
                                </div>
                            </div>
                            <div class="bottom-center">
                                <span class="airport">{{ pireps_flights.first.aircraft }}</span>
                            </div>
                        </div>

                    </div><!--//app-card-body-->
                    <a class="app-card-link-mask" href="#"></a>
                </div><!--//app-card-->
            </div><!--//col-->


            <div class="col-6 col-lg-3">
                <div class="app-card app-card-stat shadow-sm h-100">
                    <div class="app-card-body p-3 p-lg-4">
                        <h4 class="stats-type mb-1">Voos arquivados</h4>
                        <br>
                        <div class="stats-figure">{{ total_approved_flights }}</div>
                        <div class="stats-meta text-success">

                        </div>
                    </div><!--//app-card-body-->
                    <a class="app-card-link-mask" href="#"></a>
                </div><!--//app-card-->
            </div><!--//col-->
            <div class="col-6 col-lg-3">
                <div class="app-card app-card-stat shadow-sm h-100">
                    <div class="app-card-body p-3 p-lg-4">
                        <h4 class="stats-type mb-1">Total de horas</h4>
                        <br>
                        {% if total_approved_hours is not None %}
                        <div class="stats-figure">{{ total_approved_hours }}</div>
                        {% else %}
                        <div class="stats-figure">00:00:00</div>
                        {% endif %}
                    </div><!--//app-card-body-->
                    <a class="app-card-link-mask" href="#"></a>
                </div><!--//app-card-->
            </div><!--//col-->
            <div class="col-6 col-lg-3">
                <div class="app-card app-card-stat shadow-sm h-100">
                    <div class="app-card-body p-3 p-lg-4">
                        <h4 class="stats-type mb-1">Patente</h4>
                        <br>
                        <div>
                            {% if total_approved_hours > 500 %}
                            <img src="{% static 'image/patente/CMD.png' %}" alt="" style="width: 150px;">
                            {% elif total_approved_hours > 250 %}
                            <img src="{% static 'image/patente/POF.png' %}" alt="" style="width: 150px;">
                            {% elif total_approved_hours > 200 %}
                            <img src="{% static 'image/patente/COP2.png' %}" alt="" style="width: 150px;">
                            {% else %}
                            <img src="{% static 'image/patente/COP.png' %}" alt="" style="width: 150px;">
                            {% endif %}
                        </div>
                    </div><!--//app-card-body-->
                    <a class="app-card-link-mask" href="#"></a>
                </div><!--//app-card-->
            </div><!--//col-->
        </div><!--//row-->
        <div class="row g-4 mb-4">
            <div class="col-12 col-lg-6">
                <div class="app-card app-card-chart h-100 shadow-sm">
                    <div class="app-card-header p-3">
                        <div class="row justify-content-between align-items-center">
                            <div class="col-auto">
                                <h4 class="app-card-title">Planos de voo</h4>
                            </div><!--//col-->
                            <div class="col-auto">
                                <div class="card-header-action">
                                    Nos √∫ltimos 30 dias
                                </div><!--//card-header-actions-->
                            </div><!--//col-->
                        </div><!--//row-->
                    </div><!--//app-card-header-->
                    <div class="app-card-body p-3 p-lg-4">

                        <div class="chart-container">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div><!--//app-card-body-->
                </div><!--//app-card-->
            </div><!--//col-->
            <div class="col-12 col-lg-6">
                <div class="app-card app-card-chart h-100 shadow-sm">
                    <div class="app-card-header p-3">
                        <div class="row justify-content-between align-items-center">
                            <div class="col-auto">
                                <h4 class="app-card-title">Tipos de Aeronaves</h4>
                            </div><!--//col-->
                            <div class="col-auto">
                                <div class="card-header-action">
                                    Nos √∫ltimos 30 dias
                                </div><!--//card-header-actions-->
                            </div><!--//col-->
                        </div><!--//row-->
                    </div><!--//app-card-header-->
                    <div class="app-card-body p-3 p-lg-4">

                        <div class="chart-container">
                            <canvas id="myChartPizza"></canvas>
                        </div>
                    </div><!--//app-card-body-->
                </div><!--//app-card-->
            </div><!--//col-->

        </div><!--//row-->
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th class="text-center">DATA</th>
                    <th class="text-center">FLIGHT</th>
                    <th class="text-center">ROTA</th>
                    <th class="text-center">AERONAVE</th>
                    <th class="text-center">STATUS</th>
                    <th class="text-center">VIEW</th>
                    <th class="text-center">EDITA</th>
                    <th class="text-center">PDF</th>
                </tr>
            </thead>
            <tbody>
                {% for pireps_flight in pireps_flights %}
                {% if forloop.counter <= 4 %} <tr>
                    <td>{{ pireps_flight.registration_date|date:"d/m/y" }}</td>
                    <td>{{ pireps_flight.flight_icao }}{{ pireps_flight.flight_number }}</td>
                    <td>{{ pireps_flight.departure_airport }} - {{ pireps_flight.arrival_airport }}
                    </td>
                    <td>{{ pireps_flight.aircraft }}</td>
                    <td>
                        {% if pireps_flight.status == 'Em an√°lise' %}
                        <span class="badge rounded-pill text-bg-warning">{{ pireps_flight.status }}</span>
                        {% elif pireps_flight.status == 'Aprovado' %}
                        <span class="badge rounded-pill text-bg-success">{{ pireps_flight.status }}</span>
                        {% else %}
                        <span class="badge rounded-pill text-bg-danger">{{ pireps_flight.status }}</span>
                        {% endif %}

                        {% if pireps_flight.event == 'S' %}
                        <span class="badge rounded-pill text-bg-info">Evento</span>
                        {% endif %}
                    </td>
                    {% if pireps_flight.status == 'Aprovado' %}
                    <td>
                        <a class="btn btn-info" href="{% url 'briefing' pireps_flight.id %}" role="button"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-eye"></i>
                        </a>

                    </td>
                    <td>
                        <a class="btn btn-warning disabled" href="{% url 'pirepsflighteditePage' pireps_flight.id %}"
                            role="button" aria-disabled="true"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-pencil"></i>
                        </a>

                    </td>
                    <td>
                        <a class="btn btn-danger" href="#" role="button"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-file-pdf"></i>
                        </a>
                    </td>
                    {% elif pireps_flight.status == 'Em an√°lise' %}
                    <td>
                        <a class="btn btn-info" href="{% url 'briefing' pireps_flight.id %}" role="button"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-eye"></i>
                        </a>

                    </td>
                    <td>
                        <a class="btn btn-warning " href="{% url 'pirepsflighteditePage' pireps_flight.id %}"
                            role="button"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-pencil"></i>
                        </a>

                    </td>
                    <td>
                        <a class="btn btn-danger disabled" href="#" role="button" aria-disabled="true"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-file-pdf"></i>
                        </a>
                    </td>
                    {% else %}
                    <td>
                        <a class="btn btn-info" href="{% url 'briefing' pireps_flight.id %}" role="button"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-eye"></i>
                        </a>

                    </td>
                    <td>
                        <a class="btn btn-warning disabled" href="{% url 'pirepsflighteditePage' pireps_flight.id %}"
                            role="button" aria-disabled="true"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-pencil"></i>
                        </a>

                    </td>
                    <td>
                        <a class="btn btn-danger disabled" href="#" role="button" aria-disabled="true"
                            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                            <i class="fa-solid fa-file-pdf"></i>
                        </a>
                    </td>
                    </tr>
                    {% endif %}
                    {% endif %}
                    {% endfor %}
            </tbody>
        </table>


        <div class="row g-4 mb-4">
            <div class="col-12 col-lg-4">
                <div class="app-card app-card-basic d-flex flex-column align-items-start shadow-sm">
                    <div class="app-card-header p-3 border-bottom-0">
                        <div class="row align-items-center gx-3">
                            <div class="col-auto">
                                <div class="app-icon-holder">
                                    <i class="fa-solid fa-user-plus"></i>
                                </div><!--//icon-holder-->

                            </div><!--//col-->
                            <div class="col-auto">
                                <h4 class="app-card-title">Top 5 Pontua√ß√£o</h4>
                            </div><!--//col-->
                        </div><!--//row-->
                    </div><!--//app-card-header-->
                    <div class="app-card-body px-4">

                        <div class="intro">
                            <table class="table table-striped">
                                <thead>
                                    <tr class="text-center">
                                        <th>Posi√ß√£o</th>
                                        <th></th>
                                        <th>Usu√°rio</th>
                                        <th>Pontua√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user, score in top_5_users %}
                                    <tr class="text-center">
                                        <td>
                                            {% if forloop.counter == 1 %}
                                            <i class="fas fa-trophy gold" style="color: rgb(211, 156, 4);"></i>
                                            <!-- Trof√©u de ouro para o primeiro lugar -->
                                            {% elif forloop.counter == 2 %}
                                            <i class="fas fa-trophy silver" style="color: silver;"></i>
                                            <!-- Trof√©u de prata para o segundo lugar -->
                                            {% elif forloop.counter == 3 %}
                                            <i class="fas fa-trophy bronze" style="color: #cd7f32;"></i>
                                            <!-- Trof√©u de bronze para o terceiro lugar -->
                                            {% else %}
                                            {{ forloop.counter }} <!-- Outras posi√ß√µes -->
                                            {% endif %}
                                        </td>
                                        <td><img src="{{ user.email|gravatar_url:80 }}" alt="User Gravatar"
                                                class="rounded-image" style="width: 20px; height: 20px; "></td>
                                        <td>{{ user.first_name }} {{ user.last_name}}</td>
                                        <td>{{ score }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div><!--//app-card-body-->

                </div><!--//app-card-->
            </div><!--//col-->
            <div class="col-12 col-lg-4">
                <div class="app-card app-card-basic d-flex flex-column align-items-start shadow-sm">
                    <div class="app-card-header p-3 border-bottom-0">
                        <div class="row align-items-center gx-3">
                            <div class="col-auto">
                                <div class="app-icon-holder">
                                    <i class="fa-solid fa-plane-departure"></i>
                                </div><!--//icon-holder-->

                            </div><!--//col-->
                            <div class="col-auto">
                                <h4 class="app-card-title">Top 5 Voos</h4>
                            </div><!--//col-->
                        </div><!--//row-->
                    </div><!--//app-card-header-->
                    <div class="app-card-body px-4 card-center">

                        <div class="intro">
                            <table class="table table-striped">
                                <thead>
                                    <tr class="text-center">
                                        <th>Posi√ß√£o</th>
                                        <th></th>
                                        <th>Usu√°rio</th>
                                        <th>Total de Voos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user, total_flights in top_5_usersfliths %}
                                    <tr class="text-center">
                                        <td>
                                            {% if forloop.counter == 1 %}
                                            <i class="fas fa-trophy gold" style="color: rgb(211, 156, 4);"></i>
                                            <!-- Trof√©u de ouro para o primeiro lugar -->
                                            {% elif forloop.counter == 2 %}
                                            <i class="fas fa-trophy silver" style="color: silver;"></i>
                                            <!-- Trof√©u de prata para o segundo lugar -->
                                            {% elif forloop.counter == 3 %}
                                            <i class="fas fa-trophy bronze" style="color: #cd7f32;"></i>
                                            <!-- Trof√©u de bronze para o terceiro lugar -->
                                            {% else %}
                                            {{ forloop.counter }} <!-- Outras posi√ß√µes -->
                                            {% endif %}
                                        </td>
                                        <td><img src="{{ user.email|gravatar_url:80 }}" alt="User Gravatar"
                                                class="rounded-image" style="width: 20px; height: 20px; "></td>
                                        <td>{{ user.first_name }} {{ user.last_name}}</td>
                                        <td>{{ total_flights }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div><!--//app-card-body-->

                </div><!--//app-card-->
            </div><!--//col-->
            <div class="col-12 col-lg-4">
                <div class="app-card app-card-basic d-flex flex-column align-items-start shadow-sm">
                    <div class="app-card-header p-3 border-bottom-0">
                        <div class="row align-items-center gx-3">
                            <div class="col-auto">
                                <div class="app-icon-holder">
                                    <i class="fa-solid fa-clock"></i>
                                </div><!--//icon-holder-->

                            </div><!--//col-->
                            <div class="col-auto">
                                <h4 class="app-card-title">Top 5 Horas de Voos</h4>
                            </div><!--//col-->
                        </div><!--//row-->
                    </div><!--//app-card-header-->
                    <div class="app-card-body px-4 card-center">

                        <div class="intro">
                            <table class="table table-striped">
                                <thead>
                                    <tr class="text-center">
                                        <th>Posi√ß√£o</th>
                                        <th></th>
                                        <th>Usu√°rio</th>
                                        <th>Horas de Voo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user, total_hours in top_5_userstime %}
                                    <tr class="text-center">
                                        <td>
                                            {% if forloop.counter == 1 %}
                                            <i class="fas fa-trophy gold" style="color: rgb(211, 156, 4);"></i>
                                            <!-- Trof√©u de ouro para o primeiro lugar -->
                                            {% elif forloop.counter == 2 %}
                                            <i class="fas fa-trophy silver" style="color: silver;"></i>
                                            <!-- Trof√©u de prata para o segundo lugar -->
                                            {% elif forloop.counter == 3 %}
                                            <i class="fas fa-trophy bronze" style="color: #cd7f32;"></i>
                                            <!-- Trof√©u de bronze para o terceiro lugar -->
                                            {% else %}
                                            {{ forloop.counter }} <!-- Outras posi√ß√µes -->
                                            {% endif %}
                                        </td>
                                        <td><img src="{{ user.email|gravatar_url:80 }}" alt="User Gravatar"
                                                class="rounded-image" style="width: 20px; height: 20px; "></td>
                                        <td>{{ user.first_name }} {{ user.last_name}}</td>
                                        <td>{{ total_hours }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div><!--//app-card-body-->

                </div><!--//app-card-->
            </div><!--//col-->
        </div><!--//row-->

    </div><!--//container-fluid-->
</div><!--//app-content-->
<!-- Inclua o script para inicializar o gr√°fico -->

<script>
    function createLineChart(ctx, labels, data) {
        var gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(75,192,192,0.4)'); // Cor inicial
        gradient.addColorStop(1, 'rgba(255,255,255,0)'); // Cor final (transparente)

        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    lineTension: 0.1,
                    backgroundColor: gradient,
                    borderColor: "rgba(75,192,192,1)",
                    borderCapStyle: 'butt',
                    borderDash: [],
                    borderDashOffset: 0.0,
                    borderJoinStyle: 'miter',
                    pointBorderColor: "rgba(75,192,192,1)",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 1,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: "rgba(75,192,192,1)",
                    pointHoverBorderColor: "rgba(220,220,220,1)",
                    pointHoverBorderWidth: 2,
                    pointRadius: 5,
                    pointHitRadius: 10,
                }]
            },
            options: {
                elements: {
                    line: {
                        tension: 0.4
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Datas'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function createDoughnutChart(ctx, labels, data) {
        var total = data.reduce((acc, val) => acc + val, 0);

        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(70,130,180)',
                        'rgba(173,216,230)',
                        'rgba(135,206,235)',
                        'rgba(204,229,255)',
                        'rgba(0,191,255)',
                        'rgba(30,144,255)',
                    ],
                    borderColor: [
                        'rgba(70,130,180)',
                        'rgba(173,216,230)',
                        'rgba(135,206,235)',
                        'rgba(204,229,255)',
                        'rgba(0,191,255)',
                        'rgba(30,144,255)',
                    ],
                    borderWidth: 2
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right'
                    },
                    datalabels: {
                        display: true,
                        color: '#000',
                        textAlign: 'center',
                        font: {
                            weight: 'bold',
                            size: 16
                        },
                        formatter: function (value, context) {
                            return ((value / total) * 100).toFixed(0) + '%';
                        },
                    },
                    annotation: {
                        annotations: {
                            centerText: {
                                type: 'label',
                                position: 'center',
                                content: [`Total`, `${total}`],
                                font: {
                                    size: 24,
                                    weight: 'bold'
                                },
                                color: 'black',
                                textAlign: 'center',
                                display: true
                            }
                        }
                    }
                }
            }
        });
    }

    var ctxLine = document.getElementById('myChart').getContext('2d');
    var labelsLine = {{ dates| safe }};
    var dataLine = {{ counts| safe }};
    var lineChart = createLineChart(ctxLine, labelsLine, dataLine);

    var ctxDoughnut = document.getElementById('myChartPizza').getContext('2d');
    var labelsDoughnut = {{ aircraft_labels| safe }};
    var dataDoughnut = {{ aircraft_counts| safe }};
    var doughnutChart = createDoughnutChart(ctxDoughnut, labelsDoughnut, dataDoughnut);



    const url = 'https://raw.githubusercontent.com/mwgg/Airports/master/airports.json';

    // Fun√ß√£o ass√≠ncrona para obter dados do JSON de aeroportos
    async function fetchAirports() {
        const response = await fetch(url);
        return await response.json();
    }

    async function displayAirports() {
        // Obter dados dos elementos HTML
        const depCode = document.getElementById('departures');
        const arrCode = document.getElementById('arrivals');

        // Obt√©m dados do JSON de aeroportos
        const airportsData = await fetchAirports();

        // Obt√©m dados dos aeroportos de partida, chegada e alternativo
        const depAirport = airportsData[depCode.textContent];
        const arrAirport = airportsData[arrCode.textContent];

        // Selecionar os elementos onde voc√™ deseja exibir os resultados
        const depResultElement = document.getElementById('departure-result');
        const arrResultElement = document.getElementById('arrival-result');

        console.log(depAirport);
        console.log(arrAirport);
        // Atualizar o conte√∫do dos elementos com as informa√ß√µes dos aeroportos
        depResultElement.innerHTML = `<p>${depAirport.iata}</p>`;
        arrResultElement.innerHTML = `<p>${arrAirport.iata}</p>`;
    }

    // Chame a fun√ß√£o para exibir os dados dos aeroportos
    displayAirports();
</script>

{% endblock %}